<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>AI 맛집 추천 시스템</title>
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a75cdf5ed76a8f93be7cb7e8a63f114f"></script>
  <!-- 참고: 위 key는 REST API 키입니다. 실제 서비스에서는 Kakao Developers에서 발급받은 Javascript 키를 사용하는 것을 권장합니다. -->
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; line-height: 1.6; padding: 20px; }
    h2 { text-align: center; }
    #controls { text-align: center; margin-bottom: 20px; }
    ul { list-style: none; padding: 0; }
    li { background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
    li img { width: 120px; height: 120px; object-fit: cover; margin-right: 20px; border-radius: 5px; float: left; }
    li .content { overflow: hidden; }
    li strong { font-size: 1.2em; }
    .summary { margin-top: 10px; font-style: italic; color: #555; border-left: 3px solid #007bff; padding-left: 10px; }
    .loader { text-align: center; font-size: 1.2em; }
  </style>
</head>
<body>
  <h2>AI 기반 맛집 추천 시스템</h2>
  <div id="controls">
    <input type="text" id="query" placeholder="예: '조용한 데이트용 파스타 맛집'" style="width: 250px; padding: 8px;">
    <button onclick="startRecommendation()">내 주변에서 찾아줘</button>
  </div>
  <div id="map" style="width:100%;height:350px;margin-bottom:20px;border-radius:8px;border:1px solid #ddd;"></div>
  <ul id="result"></ul>

  <script>
    // --- API 키 설정 ---
    const KAKAO_API_KEY = 'a75cdf5ed76a8f93be7cb7e8a63f114f';
    const PERPLEXITY_API_KEY = "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";

    const resultList = document.getElementById('result');

    // NEW: AI를 사용해 사용자 쿼리를 검색용 키워드로 변환
    async function getSearchKeyword(userQuery) {
        const prompt = `A user in Korea wants to find a place. Their natural language query is "${userQuery}". From this query, extract a single, simple, general category keyword in Korean that can be used for a map search. For example, if the query is "7000원 가성비 식당", a good keyword is "한식" or "분식". If the query is "분위기 좋은 파스타", a good keyword is "파스타". Return ONLY the single keyword itself.`;
        try {
            const response = await fetch("https://api.perplexity.ai/chat/completions", {
                method: "POST",
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json",
                    "authorization": `Bearer ${PERPLEXITY_API_KEY}`
                },
                body: JSON.stringify({
                    model: "pplx-7b-online",
                    messages: [{ role: "user", content: prompt }]
                }),
            });
            const data = await response.json();
            // 따옴표나 공백 등 불필요한 문자를 제거합니다.
            return data.choices[0].message.content.replace(/["'.]/g, '').trim();
        } catch (e) {
            console.error("Perplexity 키워드 변환 오류:", e);
            return "맛집"; // 실패 시 기본 키워드 사용
        }
    }

    // 2단계: Perplexity로 URL 내용 요약
    async function getPerplexitySummary(placeName, url) {
        if (!url) return "이 장소에 대한 온라인 정보를 찾을 수 없었습니다.";
        const prompt = `From the website ${url}, analyze the user reviews for the restaurant "${placeName}". Summarize what customers are saying. What are the most common points of praise (e.g., specific dishes, atmosphere)? Are there any common complaints? Provide this summary in a short, easy-to-read paragraph in Korean.`;
        
        try {
            const response = await fetch("https://api.perplexity.ai/chat/completions", {
                method: "POST",
                headers: {
                    "accept": "application/json",
                    "content-type": "application/json",
                    "authorization": `Bearer ${PERPLEXITY_API_KEY}`
                },
                body: JSON.stringify({
                    model: "pplx-7b-online",
                    messages: [{ role: "user", content: prompt }]
                }),
            });
            const data = await response.json();
            return data.choices[0].message.content;
        } catch (e) {
            console.error("Perplexity 요약 오류:", e);
            return "AI 요약 생성에 실패했습니다.";
        }
    }

    // 1단계: 카카오맵으로 주변 장소 검색 및 전체 프로세스 시작
    async function startRecommendation() {
        const userQuery = document.getElementById('query').value;
        if (!userQuery) {
          alert('검색어를 입력해주세요.');
          return;
        }

        if (!navigator.geolocation) {
            alert('이 브라우저는 위치 정보를 지원하지 않습니다.');
            return;
        }
        resultList.innerHTML = '<div class="loader">AI가 검색어를 분석하는 중...</div>';

        // AI를 호출하여 검색용 키워드를 먼저 얻습니다.
        const searchKeyword = await getSearchKeyword(userQuery);
        
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            // --- 지도 생성 ---
            const mapContainer = document.getElementById('map');
            const mapOption = {
                center: new kakao.maps.LatLng(lat, lng),
                level: 5
            };
            const map = new kakao.maps.Map(mapContainer, mapOption);

            // --- 현재 위치 마커 생성 ---
            const userMarkerPosition = new kakao.maps.LatLng(lat, lng);
            const userMarker = new kakao.maps.Marker({
                position: userMarkerPosition,
                title: "현재 위치"
            });
            userMarker.setMap(map);
            
            resultList.innerHTML = `<div class="loader">"'${searchKeyword}'" 주변 장소를 검색중...</div>`;
            // AI가 생성한 키워드를 사용하여 카카오맵을 검색합니다.
            const kakaoUrl = `https://dapi.kakao.com/v2/local/search/keyword.json?query=${encodeURIComponent(searchKeyword)}&x=${lng}&y=${lat}&radius=2000&size=5`;
            
            const res = await fetch(kakaoUrl, { headers: { 'Authorization': `KakaoAK ${KAKAO_API_KEY}` } });
            const data = await res.json();
            
            if (data.documents.length) {
                resultList.innerHTML = `<div class="loader">AI가 장소별 특징을 분석하는 중... (최대 1분 소요)</div>`;
                const placesHtml = await Promise.all(data.documents.map(async place => {
                    // --- 장소 마커 생성 ---
                    const markerPosition = new kakao.maps.LatLng(place.y, place.x);
                    const marker = new kakao.maps.Marker({ map: map, position: markerPosition, title: place.place_name });
                    const infowindow = new kakao.maps.InfoWindow({
                        content: `<div style="padding:5px;font-size:12px;text-align:center;">${place.place_name}</div>`,
                        removable: true
                    });
                    kakao.maps.event.addListener(marker, 'click', function() { infowindow.open(map, marker); });

                    const placeUrl = place.place_url; // Use Kakao's direct place URL for Perplexity
                    const summary = await getPerplexitySummary(place.place_name, placeUrl);
                    
                    return `
                      <li>
                        <div class="content">
                          <strong>${place.place_name}</strong><br>
                          <small>주소: ${place.road_address_name || place.address_name}</small><br>
                          <small>카테고리: ${place.category_name.split(' > ').pop()}</small>
                          <p class="summary">${summary}</p>
                          <a href="${place.place_url}" target="_blank">카카오맵에서 상세정보 보기</a>
                        </div>
                      </li>`;
                }));
                resultList.innerHTML = placesHtml.join('');
            } else {
                resultList.innerHTML = '<li>주변에 적절한 장소가 없습니다.</li>';
            }
        }, (err) => {
            resultList.innerHTML = '<li>위치 정보를 가져올 수 없습니다.</li>';
        });
    }
  </script>
</body>
</html> 